<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Makhabbat ¬∑ –ß–∞—Ç</title>
  <style>
    :root {
      --primary: #14b8a6;
      --primary-dark: #0d9488;
      --light: #f8fffe;
      --gray: #64748b;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      margin: 0;
      padding: 20px;
      color: #1e293b;
      min-height: 100vh;
    }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(20,184,166,0.1);
      margin: 0 auto 24px;
      max-width: 420px;
      padding: 24px;
    }
    .auth-bar {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    .user-avatar {
      width: 44px; height: 44px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--primary);
    }
    .user-info { flex: 1; min-width: 0; }
    .user-name { font-weight: 600; color: #0f766e; }
    .logout-btn {
      background: #ef4444; color: white;
      border: none; padding: 8px 16px;
      border-radius: 8px; cursor: pointer;
    }
    h3 { text-align: center; margin: 0 0 16px; color: #0f766e; }
    /* –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
    .users-list {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding: 12px 0;
      margin: 0 -24px;
      padding-left: 24px;
      padding-right: 24px;
      scrollbar-width: thin;
    }
    .users-list::-webkit-scrollbar { height: 6px; }
    .users-list::-webkit-scrollbar-thumb { background: #99f6e4; border-radius: 3px; }
    .user-card {
      cursor: pointer;
      text-align: center;
      min-width: 72px;
      transition: transform 0.15s;
    }
    .user-card:hover { transform: scale(1.08); }
    .user-card img {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: 2px solid #e6fffa;
      object-fit: cover;
    }
    .user-card div {
      margin-top: 6px;
      font-size: 0.84rem;
      color: #0f766e;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* –ß–∞—Ç */
    #chatPage { display: none; }
    .chat-header-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(20,184,166,.1);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 16px;
    }
    .back-btn {
      background: #f0fdfa;
      color: #0f766e;
      border: 1px solid #99f6e4;
      width: auto;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: .9rem;
      font-weight: 600;
      cursor: pointer;
    }
    .back-btn:hover { background: #ccfbf1; }
    .chat-partner-info { flex: 1; }
    .chat-partner-name { font-weight: 700; color: #0f766e; }
    .messages-wrap {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(20,184,166,.1);
      padding: 16px 20px;
      margin-bottom: 16px;
    }
    #messagesList {
      height: 360px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-right: 4px;
    }
    #messagesList::-webkit-scrollbar { width: 5px; }
    #messagesList::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
    #messagesList::-webkit-scrollbar-thumb { background: #99f6e4; border-radius: 10px; }
    .msg-bubble {
      max-width: 78%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: .92rem;
      line-height: 1.45;
      word-break: break-word;
    }
    .msg-bubble.mine {
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 4px;
      align-self: flex-end;
    }
    .msg-bubble.theirs {
      background: #f0fdfa;
      color: #1e293b;
      border: 1px solid #ccfbf1;
      border-bottom-left-radius: 4px;
      align-self: flex-start;
    }
    .msg-bubble .msg-time {
      font-size: .72rem;
      opacity: .65;
      margin-top: 4px;
      display: block;
    }
    .chat-input-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #chatInput {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #bae6fd;
      border-radius: 24px;
      font-size: .95rem;
      background: var(--light);
    }
    #chatInput:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(20,184,166,.15);
    }
    #sendMsgBtn {
      width: 46px; height: 46px;
      border-radius: 50%;
      padding: 0;
      background: var(--primary);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #sendMsgBtn:hover { background: var(--primary-dark); }
    #sendMsgBtn svg { fill: white; width: 20px; height: 20px; }
    .empty-chat {
      text-align: center;
      color: var(--gray);
      padding: 80px 0;
      font-size: .95rem;
    }
    .footer-heart {
      text-align: center;
      margin-top: 32px;
      font-size: 2.2rem;
      color: var(--primary);
      opacity: .6;
    }
  </style>
</head>
<body>

<!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
<div id="mainPage">
  <div class="card auth-bar">
    <button id="loginBtn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    <div id="userInfo" style="display:none; flex:1; display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
      <img id="userPhoto" class="user-avatar" src="" alt="">
      <div class="user-info">
        <div class="user-name" id="displayName"></div>
      </div>
      <button id="logoutBtn" class="logout-btn">–í—ã–π—Ç–∏</button>
    </div>
  </div>

  <div class="card">
    <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</h3>
    <div class="users-list" id="usersList"></div>
  </div>

  <div class="footer-heart">üíô</div>
</div>

<!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —á–∞—Ç–∞ -->
<div id="chatPage">
  <div class="chat-header-card">
    <button class="back-btn" id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
    <img id="chatPartnerPhoto" class="user-avatar" src="" alt="">
    <div class="chat-partner-info">
      <div class="chat-partner-name" id="chatPartnerName">‚Äî</div>
    </div>
  </div>

  <div class="messages-wrap">
    <div id="messagesList"><div class="empty-chat">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É üíô</div></div>
  </div>

  <div class="card" style="padding: 16px 20px;">
    <div class="chat-input-row">
      <input type="text" id="chatInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
      <button id="sendMsgBtn">
        <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>

  <div class="footer-heart">üíô</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, addDoc, query, orderBy, onSnapshot,
         serverTimestamp, getDocs }
  from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDu6927LCfBvL0K9XNZtCgEL52mhq2amrA",
  authDomain: "makhabbat-1f840.firebaseapp.com",
  projectId: "makhabbat-1f840",
  storageBucket: "makhabbat-1f840.firebasestorage.app",
  messagingSenderId: "121208793887",
  appId: "1:121208793887:web:d7354b354967b6118cde2a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

let currentChatId = null;
let unsubscribeChat = null;

// ‚îÄ‚îÄ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
onAuthStateChanged(auth, async user => {
  if (user) {
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('userInfo').style.display = 'flex';
    document.getElementById('userPhoto').src = user.photoURL || 'https://via.placeholder.com/44';
    document.getElementById('displayName').textContent = user.displayName || '–í—ã';

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await setDoc(doc(db, "users", user.uid), {
      name: user.displayName || "–ë–µ–∑ –∏–º–µ–Ω–∏",
      photo: user.photoURL || null,
      email: user.email,
      lastSeen: serverTimestamp()
    }, { merge: true });

    loadUsersList();
  } else {
    document.getElementById('loginBtn').style.display = 'block';
    document.getElementById('userInfo').style.display = 'none';
    document.getElementById('usersList').innerHTML = '';
  }
});

document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, provider);
document.getElementById('logoutBtn').onclick = () => signOut(auth);

// ‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadUsersList() {
  const snap = await getDocs(collection(db, "users"));
  const container = document.getElementById('usersList');
  container.innerHTML = '';

  snap.forEach(docSnap => {
    const data = docSnap.data();
    if (docSnap.id === auth.currentUser?.uid) return;

    const card = document.createElement('div');
    card.className = 'user-card';
    card.innerHTML = `
      <img src="${data.photo || 'https://via.placeholder.com/56'}" alt="">
      <div>${data.name.split(' ')[0] || '‚Äî'}</div>
    `;
    card.onclick = () => openChat(docSnap.id, data.name, data.photo);
    container.appendChild(card);
  });
}

// ‚îÄ‚îÄ –û—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openChat(targetUid, targetName, targetPhoto) {
  document.getElementById('chatPartnerName').textContent = targetName || '‚Äî';
  document.getElementById('chatPartnerPhoto').src = targetPhoto || 'https://via.placeholder.com/44';

  const myUid = auth.currentUser.uid;
  currentChatId = myUid < targetUid ? `${myUid}_${targetUid}` : `${targetUid}_${myUid}`;

  if (unsubscribeChat) unsubscribeChat();

  const q = query(
    collection(db, "chats", currentChatId, "messages"),
    orderBy("timestamp", "asc")
  );

  unsubscribeChat = onSnapshot(q, snapshot => {
    const list = document.getElementById('messagesList');
    list.innerHTML = '';

    if (snapshot.empty) {
      list.innerHTML = '<div class="empty-chat">–ü–æ–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç. –ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤—ã–º! üíô</div>';
      return;
    }

    snapshot.forEach(mDoc => {
      const m = mDoc.data();
      const isMine = m.senderId === auth.currentUser.uid;
      const div = document.createElement('div');
      div.className = `msg-bubble ${isMine ? 'mine' : 'theirs'}`;
      const time = m.timestamp
        ? new Date(m.timestamp.toDate()).toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'})
        : '';
      div.innerHTML = `${m.text}<span class="msg-time">${time}</span>`;
      list.appendChild(div);
    });

    list.scrollTop = list.scrollHeight;
  });

  document.getElementById('mainPage').style.display = 'none';
  document.getElementById('chatPage').style.display = 'block';
}

// ‚îÄ‚îÄ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('sendMsgBtn').onclick = async () => {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text || !currentChatId || !auth.currentUser) return;

  await addDoc(collection(db, "chats", currentChatId, "messages"), {
    senderId: auth.currentUser.uid,
    text,
    timestamp: serverTimestamp()
  });

  input.value = '';
};

document.getElementById('chatInput').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    document.getElementById('sendMsgBtn').click();
  }
});

// ‚îÄ‚îÄ –í–æ–∑–≤—Ä–∞—Ç –Ω–∞–∑–∞–¥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('backBtn').onclick = () => {
  if (unsubscribeChat) {
    unsubscribeChat();
    unsubscribeChat = null;
  }
  currentChatId = null;
  document.getElementById('chatPage').style.display = 'none';
  document.getElementById('mainPage').style.display = 'block';
  document.getElementById('messagesList').innerHTML = '<div class="empty-chat">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É üíô</div>';
};
</script>
</body>
</html>
