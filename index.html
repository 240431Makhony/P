<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Makhabbat</title>
  <style>
    :root {
      --primary: #14b8a6;
      --primary-dark: #0d9488;
      --light: #f8fffe;
      --gray: #64748b;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      margin: 0;
      padding: 20px 20px 40px;
      color: #1e293b;
      min-height: 100vh;
    }

    /* â”€â”€ Shared card â”€â”€ */
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(20,184,166,0.1);
      margin: 0 auto 24px;
      max-width: 420px;
      padding: 24px;
    }

    /* â”€â”€ Auth bar â”€â”€ */
    .auth-bar {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    .user-avatar {
      width: 44px; height: 44px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--primary);
      flex-shrink: 0;
    }
    .user-info { flex: 1; min-width: 0; }
    .user-name { font-weight: 600; color: #0f766e; }
    .user-email { font-size: .9rem; color: var(--gray); }
    .logout-btn {
      background: #ef4444; color: white;
      border: none; padding: 8px 16px;
      border-radius: 8px; cursor: pointer;
    }

    /* â”€â”€ Typography â”€â”€ */
    h3 { text-align: center; margin: 0 0 8px; color: #0f766e; font-size: 1.7rem; }
    .subtitle { text-align: center; color: var(--gray); margin: 0 0 28px; font-size: .95rem; }
    label { display: block; margin-bottom: 6px; color: #334155; font-weight: 500; font-size: .95rem; }

    /* â”€â”€ Inputs â”€â”€ */
    input[type="text"], input[type="email"], input[type="file"], input[type="password"] {
      width: 100%; padding: 13px 15px; margin-bottom: 18px;
      border: 1px solid #bae6fd; border-radius: 10px;
      font-size: 1rem; background: var(--light);
    }
    input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(20,184,166,.15); }
    input[readonly] { background: #f1f5f9; color: #475569; cursor: default; }

    /* â”€â”€ Buttons â”€â”€ */
    button {
      width: 100%; padding: 13px;
      background: var(--primary); border: none;
      color: white; font-weight: 600; border-radius: 10px;
      cursor: pointer; transition: all .2s;
    }
    button:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-1px); }
    button:disabled { background: #94a3b8; cursor: not-allowed; }

    /* â”€â”€ Feed / posts â”€â”€ */
    .post {
      border: 1px solid #e2e8f0; border-radius: 12px;
      padding: 16px 18px; margin-bottom: 16px;
    }
    .post-header {
      display: flex; align-items: center; gap: 12px; margin-bottom: 10px;
    }
    .post-header .name { font-weight: 600; color: #0f766e; }
    .post-header .time { font-size: .78rem; color: var(--gray); margin-left: auto; }
    .post .email { color: #475569; margin: 4px 0 12px; word-break: break-all; }
    .uploaded-photo { max-width: 100%; border-radius: 10px; margin: 12px 0; display: block; }

    .post-actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-top: 10px; }
    .like-btn {
      display: inline-flex; align-items: center; gap: 6px;
      background: #f0fdfa; color: #0f766e;
      border: 1px solid #99f6e4; padding: 6px 14px;
      border-radius: 999px; cursor: pointer; width: auto;
      font-size: .9rem; transform: none;
    }
    .like-btn:hover { background: #ccfbf1; transform: none; }
    .write-btn {
      display: inline-flex; align-items: center; gap: 6px;
      background: #eff6ff; color: #2563eb;
      border: 1px solid #bfdbfe; padding: 6px 14px;
      border-radius: 999px; cursor: pointer; width: auto;
      font-size: .9rem; font-weight: 600; transform: none;
    }
    .write-btn:hover { background: #dbeafe; transform: none; }

    .counter, .feed-header { text-align: center; color: #0f766e; font-weight: 600; margin: 16px 0; }

    #searchInput {
      display: block; margin: 0 auto 16px; max-width: 420px;
      padding: 13px 15px; border: 1px solid #bae6fd; border-radius: 10px;
      font-size: 1rem; background: white;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CHAT PAGE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #chatPage {
      display: none;
      max-width: 420px;
      margin: 0 auto;
    }
    .chat-header-card {
      background: white; border-radius: 16px;
      box-shadow: 0 4px 20px rgba(20,184,166,.1);
      padding: 16px 20px;
      display: flex; align-items: center; gap: 14px;
      margin-bottom: 16px;
    }
    .back-btn {
      background: #f0fdfa; color: #0f766e;
      border: 1px solid #99f6e4; width: auto;
      padding: 8px 16px; border-radius: 999px;
      font-size: .9rem; font-weight: 600; cursor: pointer; transform: none;
    }
    .back-btn:hover { background: #ccfbf1; transform: none; }
    .chat-partner-info { flex: 1; }
    .chat-partner-name { font-weight: 700; color: #0f766e; }
    .chat-partner-email { font-size: .85rem; color: var(--gray); }

    .messages-wrap {
      background: white; border-radius: 16px;
      box-shadow: 0 4px 20px rgba(20,184,166,.1);
      padding: 16px 20px;
      margin-bottom: 16px;
    }
    #messagesList {
      height: 320px; overflow-y: auto;
      display: flex; flex-direction: column; gap: 8px;
      padding-right: 4px;
    }
    #messagesList::-webkit-scrollbar { width: 5px; }
    #messagesList::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
    #messagesList::-webkit-scrollbar-thumb { background: #99f6e4; border-radius: 10px; }

    .msg-bubble {
      max-width: 78%; padding: 10px 14px;
      border-radius: 16px; font-size: .92rem;
      line-height: 1.45; word-break: break-word;
      animation: bubbleIn .18s ease;
    }
    @keyframes bubbleIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: none; } }
    .msg-bubble.mine {
      background: var(--primary); color: white;
      border-bottom-right-radius: 4px; align-self: flex-end;
    }
    .msg-bubble.theirs {
      background: #f0fdfa; color: #1e293b;
      border: 1px solid #ccfbf1;
      border-bottom-left-radius: 4px; align-self: flex-start;
    }
    .msg-bubble .msg-time { font-size: .72rem; opacity: .65; margin-top: 4px; display: block; }

    .chat-input-row {
      display: flex; gap: 10px; align-items: center;
    }
    #chatInput {
      flex: 1; padding: 12px 16px;
      border: 1px solid #bae6fd; border-radius: 24px;
      font-size: .95rem; background: var(--light); margin-bottom: 0;
    }
    #chatInput:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(20,184,166,.15); }
    #sendMsgBtn {
      width: 46px; height: 46px; min-width: 46px;
      border-radius: 50%; padding: 0;
      display: flex; align-items: center; justify-content: center;
      background: var(--primary); border: none; cursor: pointer; transform: none;
    }
    #sendMsgBtn:hover { background: var(--primary-dark); transform: none; }
    #sendMsgBtn svg { fill: white; width: 20px; height: 20px; }

    .empty-chat {
      text-align: center; color: var(--gray);
      padding: 60px 0; font-size: .95rem;
    }

    .footer-heart { text-align: center; margin-top: 40px; font-size: 2rem; color: var(--primary); opacity: .7; }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â• MAIN PAGE â•â•â•â•â•â•â•â•â•â• -->
<div id="mainPage">

  <div class="card auth-bar">
    <button id="loginBtn">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Google</button>
    <div id="userInfo" style="display:none; flex:1; display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
      <img id="userPhoto" class="user-avatar" src="" alt="">
      <div class="user-info">
        <div class="user-name" id="displayName"> </div>
        <div class="user-email" id="displayEmail"> </div>
      </div>
      <button id="logoutBtn" class="logout-btn">Ğ’Ñ‹Ğ¹Ñ‚Ğ¸</button>
    </div>
  </div>

  <div class="card" id="loginPrompt">
    Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ñ‡ĞµÑ€ĞµĞ· Google, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ·Ğ°ÑĞ²ĞºĞ¸ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ²Ğ¾Ñ ğŸ’™
  </div>

  <div id="formContainer" class="card" style="display:none;">
    <h3>ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°ÑĞ²ĞºÑƒ</h3>
    <div class="subtitle">ĞœÑ‹ ÑĞ²ÑĞ¶ĞµĞ¼ÑÑ Ñ Ğ²Ğ°Ğ¼Ğ¸ Ğ² Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ ğŸ’™</div>
    <form id="feedbackForm">
      <label>Ğ˜Ğ¼Ñ</label>
      <input type="text" id="formName" readonly>
      <label>Email</label>
      <input type="email" id="formEmail" readonly>
      <label>Ğ¤Ğ¾Ñ‚Ğ¾ (Ğ½ĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾, Ğ´Ğ¾ 4 ĞœĞ‘)</label>
      <input type="file" id="photoFile" accept="image/jpeg,image/png,image/webp">
      <button type="submit" id="submitBtn">ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
    </form>
  </div>

  <input type="text" id="searchInput" placeholder="ğŸ” ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸..." style="display:none;">

  <div class="counter" id="counterBlock" style="display:none;">
    Ğ’ÑĞµĞ³Ğ¾ Ğ·Ğ°ÑĞ²Ğ¾Ğº: <span id="totalCount">â€”</span>
  </div>

  <div class="feed-header" id="feedHeader" style="display:none;">ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ·Ğ°ÑĞ²ĞºĞ¸</div>
  <div class="card" id="feed" style="display:none; padding: 20px;"></div>

  <div class="footer-heart">ğŸ’™</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• CHAT PAGE â•â•â•â•â•â•â•â•â•â• -->
<div id="chatPage">
  <div class="chat-header-card">
    <button class="back-btn" id="backBtn">â† ĞĞ°Ğ·Ğ°Ğ´</button>
    <img id="chatPartnerPhoto" class="user-avatar" src="" alt="">
    <div class="chat-partner-info">
      <div class="chat-partner-name" id="chatPartnerName">â€”</div>
      <div class="chat-partner-email" id="chatPartnerEmail">â€”</div>
    </div>
  </div>

  <div class="messages-wrap">
    <div id="messagesList"><div class="empty-chat">ĞĞ°Ñ‡Ğ½Ğ¸Ñ‚Ğµ Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞºÑƒ ğŸ’™</div></div>
  </div>

  <div class="card" style="padding: 16px 20px;">
    <div class="chat-input-row">
      <input type="text" id="chatInput" placeholder="Ğ’Ğ°ÑˆĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ...">
      <button id="sendMsgBtn">
        <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>

  <div class="footer-heart">ğŸ’™</div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp }           from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot,
         doc, updateDoc, serverTimestamp, increment, getCountFromServer }
  from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL }
  from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

/* â”€â”€ Firebase config â”€â”€ */
const firebaseConfig = {
  apiKey: "AIzaSyDu6927LCfBvL0K9XNZtCgEL52mhq2amrA",
  authDomain: "makhabbat-1f840.firebaseapp.com",
  projectId: "makhabbat-1f840",
  storageBucket: "makhabbat-1f840.firebasestorage.app",
  messagingSenderId: "121208793887",
  appId: "1:121208793887:web:d7354b354967b6118cde2a"
};

const app      = initializeApp(firebaseConfig);
const db       = getFirestore(app);
const auth     = getAuth(app);
const storage  = getStorage(app);
const provider = new GoogleAuthProvider();

/* â”€â”€ State â”€â”€ */
let allRequests    = [];
let currentUser    = null;
let unsubMessages  = null;
let chatPartner    = null; // { uid, name, email, photo }

/* â”€â”€ DOM refs â”€â”€ */
const $  = id => document.getElementById(id);
const els = {
  mainPage:       $('mainPage'),
  chatPage:       $('chatPage'),
  loginBtn:       $('loginBtn'),
  logoutBtn:      $('logoutBtn'),
  userInfo:       $('userInfo'),
  userPhoto:      $('userPhoto'),
  displayName:    $('displayName'),
  displayEmail:   $('displayEmail'),
  loginPrompt:    $('loginPrompt'),
  formContainer:  $('formContainer'),
  searchInput:    $('searchInput'),
  counterBlock:   $('counterBlock'),
  feedHeader:     $('feedHeader'),
  feed:           $('feed'),
  formName:       $('formName'),
  formEmail:      $('formEmail'),
  photoFile:      $('photoFile'),
  submitBtn:      $('submitBtn'),
  form:           $('feedbackForm'),
  // chat
  backBtn:            $('backBtn'),
  chatPartnerPhoto:   $('chatPartnerPhoto'),
  chatPartnerName:    $('chatPartnerName'),
  chatPartnerEmail:   $('chatPartnerEmail'),
  messagesList:       $('messagesList'),
  chatInput:          $('chatInput'),
  sendMsgBtn:         $('sendMsgBtn'),
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
els.loginBtn.onclick  = () => signInWithPopup(auth, provider).catch(console.error);
els.logoutBtn.onclick = () => signOut(auth).catch(console.error);

function toggleUI(isAuth) {
  const show = el => el.style.display = 'block';
  const hide = el => el.style.display = 'none';
  if (isAuth) {
    hide(els.loginBtn);
    els.userInfo.style.display = 'flex';
    hide(els.loginPrompt);
    show(els.formContainer);
    show(els.searchInput);
    show(els.counterBlock);
    show(els.feedHeader);
    els.feed.style.display = 'block';
  } else {
    show(els.loginBtn);
    els.userInfo.style.display = 'none';
    show(els.loginPrompt);
    hide(els.formContainer);
    hide(els.searchInput);
    hide(els.counterBlock);
    hide(els.feedHeader);
    hide(els.feed);
    els.feed.innerHTML = '';
  }
}

onAuthStateChanged(auth, user => {
  currentUser = user;
  if (user) {
    toggleUI(true);
    els.userPhoto.src        = user.photoURL || '';
    els.displayName.textContent  = user.displayName || 'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ';
    els.displayEmail.textContent = user.email || '';
    els.formName.value  = user.displayName || '';
    els.formEmail.value = user.email || '';
  } else {
    toggleUI(false);
    showMainPage();
  }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORM SUBMIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
els.form.addEventListener('submit', async e => {
  e.preventDefault();
  if (!currentUser) return;
  const name  = els.formName.value.trim();
  const email = els.formEmail.value.trim();
  const file  = els.photoFile.files[0];
  if (!name || !email) { alert('Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ Ğ¸ email'); return; }

  els.submitBtn.disabled = true;
  els.submitBtn.textContent = 'ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ°...';

  let photoUrl = currentUser.photoURL || null;
  try {
    if (file) {
      if (file.size > 4 * 1024 * 1024) throw new Error('Ğ¤Ğ¾Ñ‚Ğ¾ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğµ (Ğ¼Ğ°ĞºÑ. 4 ĞœĞ‘)');
      if (!file.type.startsWith('image/'))  throw new Error('Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ');
      const ext = file.name.split('.').pop() || 'jpg';
      const storageRef = ref(storage, `requests/${currentUser.uid}/${Date.now()}.${ext}`);
      await uploadBytes(storageRef, file);
      photoUrl = await getDownloadURL(storageRef);
    }
    await addDoc(collection(db, 'requests'), {
      name,
      name_lower: name.toLowerCase().trim(),
      email,
      photo: photoUrl,
      likes: 0,
      timestamp: serverTimestamp(),
      createdAt: new Date().toISOString(),
      approved: false,
      uid: currentUser.uid
    });
    alert('Ğ—Ğ°ÑĞ²ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ°! ğŸ’™');
    els.form.reset();
  } catch (err) {
    alert(err.message || 'ĞÑˆĞ¸Ğ±ĞºĞ°. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.');
  } finally {
    els.submitBtn.disabled = false;
    els.submitBtn.textContent = 'ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ';
  }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FEED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.addLike = async id => {
  try { await updateDoc(doc(db, 'requests', id), { likes: increment(1) }); }
  catch (err) { console.error(err); }
};

async function updateCount() {
  try {
    const snap = await getCountFromServer(collection(db, 'requests'));
    $('totalCount').textContent = snap.data().count;
  } catch { $('totalCount').textContent = 'â€”'; }
}

const q = query(collection(db, 'requests'), orderBy('timestamp', 'desc'));
onSnapshot(q, snap => {
  allRequests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderFeed();
  updateCount();
});

function renderFeed() {
  const term = els.searchInput.value.trim().toLowerCase();
  els.feed.innerHTML = '';
  const filtered = allRequests.filter(r => !term || (r.name || '').toLowerCase().includes(term));

  if (!filtered.length) {
    els.feed.innerHTML = '<p style="text-align:center;color:var(--gray);padding:40px 0;">ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾</p>';
    return;
  }

  filtered.forEach(r => {
    const time = r.timestamp
      ? new Date(r.timestamp.toDate()).toLocaleString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' })
      : 'â€¦';

    const isMe = currentUser && r.uid === currentUser.uid;

    const post = document.createElement('div');
    post.className = 'post';
    post.innerHTML = `
      <div class="post-header">
        <img src="${r.photo || 'https://via.placeholder.com/40'}" class="user-avatar" alt="">
        <span class="name">${r.name || 'â€”'}</span>
        <span class="time">${time}</span>
      </div>
      <div class="email">${r.email || 'â€”'}</div>
      ${r.photo ? `<img src="${r.photo}" class="uploaded-photo" alt="Ğ¤Ğ¾Ñ‚Ğ¾ Ğ·Ğ°ÑĞ²ĞºĞ¸">` : ''}
      <div class="post-actions">
        <button class="like-btn" onclick="addLike('${r.id}')">ğŸ’™ ${r.likes || 0}</button>
        ${!isMe ? `<button class="write-btn" onclick="openChatWith('${r.uid}','${escapeAttr(r.name)}','${escapeAttr(r.email)}','${escapeAttr(r.photo || '')}')">âœ‰ï¸ ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ</button>` : ''}
      </div>
    `;
    els.feed.appendChild(post);
  });
}

els.searchInput.addEventListener('input', renderFeed);

function escapeAttr(str) {
  return (str || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showMainPage() {
  els.mainPage.style.display = 'block';
  els.chatPage.style.display = 'none';
  if (unsubMessages) { unsubMessages(); unsubMessages = null; }
}
function showChatPage() {
  els.mainPage.style.display = 'none';
  els.chatPage.style.display = 'block';
  window.scrollTo(0, 0);
}

els.backBtn.onclick = showMainPage;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.openChatWith = (uid, name, email, photo) => {
  if (!currentUser) { alert('Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ'); return; }
  chatPartner = { uid, name, email, photo };

  els.chatPartnerName.textContent  = name  || 'â€”';
  els.chatPartnerEmail.textContent = email || 'â€”';
  els.chatPartnerPhoto.src = photo || 'https://via.placeholder.com/44';

  els.messagesList.innerHTML = '<div class="empty-chat">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>';
  showChatPage();

  // Unsubscribe previous listener
  if (unsubMessages) { unsubMessages(); unsubMessages = null; }

  const chatId = getChatId(currentUser.uid, uid);
  const msgsQ  = query(collection(db, 'chats', chatId, 'messages'), orderBy('ts'));

  unsubMessages = onSnapshot(msgsQ, snap => {
    els.messagesList.innerHTML = '';
    if (snap.empty) {
      els.messagesList.innerHTML = '<div class="empty-chat">ĞĞ°Ñ‡Ğ½Ğ¸Ñ‚Ğµ Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞºÑƒ ğŸ’™</div>';
      return;
    }
    snap.forEach(d => {
      const m   = d.data();
      const div = document.createElement('div');
      div.className = 'msg-bubble ' + (m.from === currentUser.uid ? 'mine' : 'theirs');
      const ts = m.ts ? new Date(m.ts.toDate()).toLocaleTimeString('ru-RU', { hour:'2-digit', minute:'2-digit' }) : '';
      div.innerHTML = `${m.text}<span class="msg-time">${ts}</span>`;
      els.messagesList.appendChild(div);
    });
    els.messagesList.scrollTop = els.messagesList.scrollHeight;
  });
};

async function sendMessage() {
  const text = els.chatInput.value.trim();
  if (!text || !chatPartner || !currentUser) return;
  els.chatInput.value = '';
  const chatId = getChatId(currentUser.uid, chatPartner.uid);
  await addDoc(collection(db, 'chats', chatId, 'messages'), {
    from: currentUser.uid,
    to:   chatPartner.uid,
    text,
    ts: serverTimestamp()
  });
}

els.sendMsgBtn.onclick = sendMessage;
els.chatInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) sendMessage(); });

function getChatId(uid1, uid2) {
  return [uid1, uid2].sort().join('_');
}
</script>
</body>
</html>
