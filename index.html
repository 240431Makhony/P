<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É ‚Äî Makhabbat</title>
  <style>
    :root {
      --primary: #14b8a6;
      --primary-dark: #0d9488;
      --light: #f8fffe;
      --gray: #64748b;
    }
    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      margin: 0;
      padding: 20px 20px 40px;
      color: #1e293b;
      min-height: 100vh;
    }
    .auth-bar, .form-container, .login-prompt, .feed {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(20,184,166,0.1);
      margin: 0 auto 24px;
      max-width: 420px;
      padding: 24px;
    }
    .auth-bar { padding: 16px 20px; display: flex; align-items: center; gap: 16px; flex-wrap: wrap; justify-content: space-between; }
    .user-avatar { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
    .user-info { flex: 1; min-width: 0; }
    .user-name { font-weight: 600; color: #0f766e; }
    .user-email { font-size: 0.9rem; color: var(--gray); }
    .logout-btn { background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; }
    h3 { text-align: center; margin: 0 0 8px; color: #0f766e; font-size: 1.7rem; }
    .subtitle { text-align: center; color: var(--gray); margin: 0 0 28px; font-size: 0.95rem; }
    label { display: block; margin-bottom: 6px; color: #334155; font-weight: 500; font-size: 0.95rem; }
    input, input[type="file"] {
      width: 100%;
      padding: 13px 15px;
      margin-bottom: 18px;
      border: 1px solid #bae6fd;
      border-radius: 10px;
      font-size: 1rem;
      background: var(--light);
    }
    input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(20,184,166,0.15); }
    input[readonly] { background: #f1f5f9; color: #475569; }
    button {
      width: 100%;
      padding: 13px;
      background: var(--primary);
      border: none;
      color: white;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-1px); }
    button:disabled { background: #94a3b8; cursor: not-allowed; }
    .post {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px 18px;
      margin-bottom: 16px;
    }
    .post-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
    .name { font-weight: 600; color: #0f766e; }
    .time { font-size: 0.78rem; color: var(--gray); margin-left: auto; }
    .email { color: #475569; margin: 4px 0 12px; word-break: break-all; }
    .uploaded-photo { max-width: 100%; border-radius: 10px; margin: 12px 0; display: block; }
    .like-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #f0fdfa;
      color: #0f766e;
      border: 1px solid #99f6e4;
      padding: 6px 14px;
      border-radius: 999px;
      cursor: pointer;
    }
    .like-btn:hover { background: #ccfbf1; }
    .counter, .feed-header { text-align: center; color: #0f766e; font-weight: 600; margin: 16px 0; }
    .footer-heart { text-align: center; margin-top: 40px; font-size: 2rem; color: var(--primary); opacity: 0.7; }
    #searchInput { margin-bottom: 16px; }
  </style>
</head>
<body>

  <div class="auth-bar">
    <button id="loginBtn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    <div id="userInfo" style="display:none; flex:1; display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
      <img id="userPhoto" class="user-avatar" src="" alt="">
      <div class="user-info">
        <div class="user-name" id="userName"></div>
        <div class="user-email" id="userEmail"></div>
      </div>
      <button id="logoutBtn" class="logout-btn">–í—ã–π—Ç–∏</button>
    </div>
  </div>

  <div class="login-prompt" id="loginPrompt">
    –í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∑–∞—è–≤–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–≤–æ—é üíô
  </div>

  <div id="formContainer" class="form-container" style="display:none;">
    <h3>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</h3>
    <div class="subtitle">–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è üíô</div>
    <form id="feedbackForm">
      <label for="userName">–ò–º—è</label>
      <input type="text" id="userName" readonly>

      <label for="userEmail">Email</label>
      <input type="email" id="userEmail" readonly>

      <label for="photoFile">–§–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –¥–æ 4 –ú–ë)</label>
      <input type="file" id="photoFile" accept="image/jpeg,image/png,image/webp">

      <button type="submit" id="submitBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  </div>

  <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏..." style="display:none; max-width:420px; margin:0 auto 16px; display:block;">

  <div class="counter" id="counterBlock" style="display:none;">
    –í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫: <span id="totalCount">‚Äî</span>
  </div>

  <div class="feed-header" id="feedHeader" style="display:none;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞—è–≤–∫–∏</div>
  <div class="feed" id="feed" style="display:none;"></div>

  <div class="footer-heart">üíô</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, query, orderBy, onSnapshot,
      doc, updateDoc, serverTimestamp, increment, getCountFromServer
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDu6927LCfBvL0K9XNZtCgEL52mhq2amrA",
      authDomain: "makhabbat-1f840.firebaseapp.com",
      projectId: "makhabbat-1f840",
      storageBucket: "makhabbat-1f840.firebasestorage.app",
      messagingSenderId: "121208793887",
      appId: "1:121208793887:web:d7354b354967b6118cde2a",
      measurementId: "G-1EXPZL942H"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    let allRequests = [];

    // DOM elements
    const els = {
      loginBtn: document.getElementById('loginBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      userInfo: document.getElementById('userInfo'),
      userPhoto: document.getElementById('userPhoto'),
      userName: document.getElementById('userName'),
      userEmail: document.getElementById('userEmail'),
      loginPrompt: document.getElementById('loginPrompt'),
      formContainer: document.getElementById('formContainer'),
      searchInput: document.getElementById('searchInput'),
      counterBlock: document.getElementById('counterBlock'),
      feedHeader: document.getElementById('feedHeader'),
      feed: document.getElementById('feed'),
      nameInput: document.getElementById('userName'),
      emailInput: document.getElementById('userEmail'),
      photoFile: document.getElementById('photoFile'),
      submitBtn: document.getElementById('submitBtn'),
      form: document.getElementById('feedbackForm')
    };

    els.loginBtn.onclick = () => signInWithPopup(auth, provider).catch(console.error);
    els.logoutBtn.onclick = () => signOut(auth).catch(console.error);

    function toggleUI(isAuth) {
      const show = (el) => el.style.display = 'block';
      const hide = (el) => el.style.display = 'none';

      if (isAuth) {
        hide(els.loginBtn);
        show(els.userInfo);
        hide(els.loginPrompt);
        show(els.formContainer);
        show(els.searchInput);
        show(els.counterBlock);
        show(els.feedHeader);
        show(els.feed);
      } else {
        show(els.loginBtn);
        hide(els.userInfo);
        show(els.loginPrompt);
        hide(els.formContainer);
        hide(els.searchInput);
        hide(els.counterBlock);
        hide(els.feedHeader);
        hide(els.feed);
        els.feed.innerHTML = '';
      }
    }

    onAuthStateChanged(auth, user => {
      if (user) {
        toggleUI(true);
        els.userPhoto.src = user.photoURL || 'https://via.placeholder.com/44';
        els.userName.textContent = user.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        els.userEmail.textContent = user.email || '';
        els.nameInput.value = user.displayName || '';
        els.emailInput.value = user.email || '';
      } else {
        toggleUI(false);
      }
    });

    els.form.addEventListener("submit", async e => {
      e.preventDefault();
      if (!auth.currentUser) return;

      const name = els.nameInput.value.trim();
      const email = els.emailInput.value.trim();
      const file = els.photoFile.files[0];

      if (!name || !email) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ email");

      els.submitBtn.disabled = true;
      els.submitBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";

      let photoUrl = auth.currentUser.photoURL || null;

      try {
        if (file) {
          if (file.size > 4 * 1024 * 1024) throw new Error("–§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å. 4 –ú–ë)");
          if (!file.type.startsWith('image/')) throw new Error("–¢–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");

          const ext = file.name.split('.').pop() || 'jpg';
          const path = `requests/${auth.currentUser.uid}/${Date.now()}.${ext}`;
          const storageRef = ref(storage, path);

          await uploadBytes(storageRef, file);
          photoUrl = await getDownloadURL(storageRef);
        }

        await addDoc(collection(db, "requests"), {
          name,
          name_lower: name.toLowerCase().trim(),
          email,
          photo: photoUrl,
          likes: 0,
          timestamp: serverTimestamp(),
          createdAt: new Date().toISOString(),
          approved: false,
          uid: auth.currentUser.uid
        });

        alert("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! üíô");
        els.form.reset();
      } catch (err) {
        console.error(err);
        alert(err.message || "–û—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
      } finally {
        els.submitBtn.disabled = false;
        els.submitBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
      }
    });

    window.addLike = async id => {
      try {
        await updateDoc(doc(db, "requests", id), { likes: increment(1) });
      } catch (err) {
        console.error(err);
      }
    };

    async function updateCount() {
      try {
        const snap = await getCountFromServer(collection(db, "requests"));
        document.getElementById("totalCount").textContent = snap.data().count;
      } catch {
        document.getElementById("totalCount").textContent = "‚Äî";
      }
    }

    const q = query(collection(db, "requests"), orderBy("timestamp", "desc"));
    onSnapshot(q, snap => {
      allRequests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderFeed();
      updateCount();
    });

    function renderFeed() {
      const term = els.searchInput.value.trim().toLowerCase();
      els.feed.innerHTML = "";

      const filtered = allRequests.filter(r => !term || r.name?.toLowerCase().includes(term));
      if (!filtered.length) {
        els.feed.innerHTML = '<p style="text-align:center; color:var(--gray); padding:60px 0;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
        return;
      }

      filtered.forEach(r => {
        const time = r.timestamp
          ? new Date(r.timestamp.toDate()).toLocaleString("ru-RU", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit" })
          : "‚Ä¶";

        const post = document.createElement("div");
        post.className = "post";
        post.innerHTML = `
          <div class="post-header">
            <img src="${r.photo || 'https://via.placeholder.com/40'}" class="user-avatar" alt="">
            <span class="name">${r.name || "‚Äî"}</span>
            <span class="time">${time}</span>
          </div>
          <div class="email">${r.email || "‚Äî"}</div>
          ${r.photo ? `<img src="${r.photo}" class="uploaded-photo" alt="–§–æ—Ç–æ –∑–∞—è–≤–∫–∏">` : ''}
          <button class="like-btn" onclick="addLike('${r.id}')">üíô ${r.likes || 0}</button>
        `;
        els.feed.appendChild(post);
      });
    }

    els.searchInput.addEventListener("input", renderFeed);
  </script>
</body>
</html>
